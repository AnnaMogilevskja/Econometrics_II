---
title: "Econometrics II - Assignment 2"
author: "Uncensored sloths"
date: "13 Jan 2022"
output:
  pdf_document:
    includes:
      in_header: "preamble.tex"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(plm)
library(SciViews)
library(stargazer)
library(magrittr)
library(dplyr)
library(fixest)
library(aod)
library(lmtest)
library(modelsummary)
library(texreg)
```

# Question 1

(i) Why does the process of taking each observation relative to its individual-level mean have
the effect of "controlling for individual effects"?\\

The process of taking each observation relative to its individual-level mean is called demeaning. When apply demeaning, the individual fixed effects are dropping out from the model as a results. Hence, we control for the individual effects but we also are not able to estimate the impact of time-invariant regressors. 

(ii) Two-way fixed effects with terms for both individual and time are often referred to as
"controlling for individual and time effects". Why might a researcher want to do this rather
than just taking individual fixed effects and adding a linear/polynomial/etc. term for time?\\

Firstly, it is easier to apply as you do not have to specify any linear or polynomial term (it is quite tricky as you need to have an idea what it the form of the impact). It especially is convenient to apply when the research only wants to control for time effects but time effects themselves are not part of the research question.

(iii) Why random effects is likely to do a better job of estimating the individual effects than
fixed effects, if its assumptions hold?\\

Because it is able to estimate timeinvariant regressors, we can also do out sample predictions, it is more efficient, etc. Look at the slides. 

\clearpage

# Question 2

```{r}
# Load data
data <- read.csv("assignment2.csv")
lnearnings <- ln(data$earnings)
data <- cbind(data, lnearnings)
```

(i) First use pooled OLS to check the impact of including and excluding asvabc on the estimate
of $\beta_1$ Present and explain the result.\\

```{r, results='asis'}
pooled1 <- plm(lnearnings ~ school + age + agesq + ethblack + urban + regne + regnc + regw, model = "pooling", data=data)
pooled2 <- plm(lnearnings ~ school + age + agesq + ethblack + urban + regne + regnc + regw + asvabc, model = "pooling", data=data)
stargazer(pooled1, pooled2)
```
The index test score has a positive significant effect at $1\%$ level on ln earnings. 
Estimators for schooling is lower in the second model which makes sense if we assume that individuals that attended school for longer time are able to achieve higher results. 
Being black has also a negative significant effect. However, the magnitude is lower if the index test score is included.

One regional dummy was excluded. As all regional dummies are positive and significant, we can conclude that the dummy that was excluded, so south, indicates that individuals in the south earn less relative to individuals living in other areas.

The adjusted $R^2$ is higher for the model including the index test score.

What about age squared?

(ii) Perform a pooled OLS analysis to obtain insight in the heterogeneity of returns to schooling
by ethnicity. Present the results and comment on the outcomes. What are the conclusions
based on this?\\

```{r, results='asis'}
pooled <- plm(lnearnings ~ school + age + agesq + ethblack + I(ethblack * school) + urban + regne + regnc + regw + asvabc, model = "pooling", data=data)
stargazer(pooled)
```
The interaction effect between schooling and being black is significant at $1\%$ and positive. So attending school has a higher impact on black people. The other estimators do not change a lot in magnitude except for the estimator black ethnicity. This estimator decreases by X ($34\%$), indicating that being black has a negative impact on earnings. Therefore, the data provide evidence that there is discrimination on the labour market.
$R^2$ does not increase, however, we get a better picture of the dynamics on the labour market and heterogeneity of the effects. 

(iii) Perform the analysis for heterogeneous schooling effects using the random effects model.
Present the results and compare the outcomes with the pooled OLS results obtained before.
Interpret the outcomes.\\

```{r, results='asis'}
random <- plm(lnearnings ~ school + age + agesq + ethblack + I(ethblack  * school) + urban + regne + regnc + regw + asvabc, model = "random", index = c("id", "time"), effect = "twoways", data=data)
random$vcov <- vcovHC(random, cluster="group")
stargazer(pooled, random)
```
We assume two-way. Time: f.e. exogeneous macroeconomic impacts that lower earnings. Individual: character traits, unobserved educational aspects, economic background, social background, etc.

The interaction between ethnicity and schooling is not significant anymore, as well as one of the regions. The magnitude of age increased. Magnitude of urban decreased. So all in all, we can see that the magnitudes of the estimators are different from OLS. $R^2$ does not have any interpretative power as the Gauss-Markov assumptions do not hold (nochmal nachschauen)

(iv) A priori, would you plead for using fixed effects estimation or random effects estimation?
Explain your answer.\\

Note that disadvanteges of fixed effext estimation are the following:\\
$\Rightarrow$ time-invariant regressors are not identified
$\Rightarrow$ out of sample prediction is impossible consequently (time-invariant regressors do not add any information)
$\Rightarrow$ need sufficient variation in X

On ther hand, it is robust to correlation between the omitted heterogeneity and the regressors. 

Note that the random-effects model can be used to make predictions outside the sample and time-invariant regressors are informative on this. However, it assumes strongers assumptions than fixed effects. Also, it is more efficient than fixed effects if the stochastic structure is correct. 

The question is whether $\eta_i$ and $\lambda_t$ are uncorrelated to the regressors. Considering that $\eta_i$ could include dimensions as character traits or social and economic backgrounds (of parents), we have to assume that this condition does not hold as these dimension have an impact on schooling f.e.
Therefore, we would plead for using a fixed effects model despite the disadvantage that it does not identify time-invariant regressors. \\


v) Apply the fixed effects estimator to analyze the heterogenous schooling effects. Interpret
the outcomes.\\

```{r, results='asis'}
fixed  <- plm(lnearnings ~ school + age + agesq + ethblack + I(ethblack  * school) + urban + regne + regnc + regw + asvabc, model = "within", index = c("id", "time"), effect = "twoways", data = data)
fixed$vcov <- vcovHC(fixed, cluster="group")
stargazer(pooled, random, fixed)
```

Interaction is significant and negative which differs from our OLS estimation. According to this estimation being black and in school has a lower impact on earnings than for individuals who are not black. Age is not identified in plm which could be cause by assuming time and individual fixed effects as this is not when we only assume individual effect. When we do it with feols, we cannot include both variables! This might be due to the time-invariance of age square - however, this would not explain why this is not an issue with the dummies where we also have a low time-invariance. 

the way twoways is calculated, age becomes zero so it drops out. However, we still would proceed with twoways as macroeconomic dynamics can have significant effects on earnings. COnsidering that the time frame includes f.e. the oil crisis, we should not ignore it. Further, age square partially incorporates the impact of age on earnings. \\

(vi) Fixed effects estimation may not be as efficient as random effects estimation, but is robust to correlation between regressors and the random effect. Can we perform a Hausman test
in this context? Perform the test you propose.\\

We can perform a hausman test between our fixed and random model with robust standard errors. Note that we included the robust standard errors in the list. It is important to consider the robust standard errors as the test is based on the estimated coeffcient variances. P value is below $1\%$. Hence, we can reject our null hypothesis. Therefore, the random effects model is inconsistent as the assumption of no correlation between the fixed effects and the regressors does not hold. 

```{r} 
phtest(fixed, random)
```


(vii) Perform Mundlak estimation of the model. Present the results of estimation and test for
the joint significance of the within-group means.\\

Wald Test for both significant - jointly significant, covariance between fixed effects and regressors. In line Hausman test.
Address issues with plm (does not includes means) but regressors are in line with fixed effects model (partially). 
Pggls is shit - nothing works. Less observations, not consistent with the fixed effect model.But including mean dummies works. We get the error singluraties in plm, so a reasong might be that the rows are too similar and plm needs more variance. Maybe pggls is better with that. 

```{r}
data <- data %>%
  group_by(id) %>%
  mutate(mean_school = mean(school),
         mean_age = mean(age),
         mean_agesq = mean(agesq),
         mean_asvabc = mean(asvabc),
         mean_urban = mean(urban),
         mean_regne = mean(regne),
         mean_regnc = mean(regnc),
         mean_regw = mean(regw))
```

```{r, results='asis'}
mundlak2 <- plm(lnearnings ~ school + age + agesq + ethblack + I(ethblack  * school) + urban + regne + regnc + regw + asvabc + mean_school+ mean_age + mean_agesq + I(ethblack*mean_school), model = "random", index = "id", data=data)
mundlak2$vcov <- vcovHC(mundlak2, cluster="group")

mundlak1 <- pggls(lnearnings ~ school + age + agesq + ethblack + I(ethblack  * school) + urban + regne + regnc + regw + asvabc + mean_school+ mean_age + mean_agesq + I(ethblack*mean_school) + mean_urban + mean_regne + mean_regnc + mean_regw, model = "random", index = c("id"), effect = "individual", data=data)

fixed_oneway  <- plm(lnearnings ~ school + age + agesq + ethblack + I(ethblack  * school) + urban + regne + regnc + regw + asvabc, model = "within", index = c("id", "time"), effect = "individual", data = data)
fixed_oneway$vcov <- vcovHC(fixed_oneway, cluster="group")

fixed_pggls <- pggls(lnearnings ~ school + age + agesq + ethblack + I(ethblack  * school) + urban + regne + regnc + regw + asvabc, model = "within", index = c("id"), effect = "individual", data=data)

```
```{r}
# pggls (http://tarohmaru.web.fc2.com/R/ExerciseDiagnostics.html)
extract.pggls <- function (model, include.rsquared = TRUE, include.adjrs = TRUE, 
    include.nobs = TRUE, ...) 
{
    s <- summary(model, ...)
    coefficient.names <- rownames(s$CoefTable)
    coefficients <- s$CoefTable[, 1]
    standard.errors <- s$CoefTable[, 2]
    significance <- s$CoefTable[, 4]
    rs <- s$rsqr
    n <- length(s$resid)
    gof <- numeric()
    gof.names <- character()
    gof.decimal <- logical()
    if (include.rsquared == TRUE) {
        gof <- c(gof, rs)
        gof.names <- c(gof.names, "R$^2$")
        gof.decimal <- c(gof.decimal, TRUE)
    }
    if (include.nobs == TRUE) {
        gof <- c(gof, n)
        gof.names <- c(gof.names, "Num. obs.")
        gof.decimal <- c(gof.decimal, FALSE)
    }
    tr <- createTexreg(coef.names = coefficient.names, coef = coefficients, 
        se = standard.errors, pvalues = significance, gof.names = gof.names, 
        gof = gof, gof.decimal = gof.decimal)
    return(tr)
}

setMethod("extract", signature = className("pggls", "plm"),
          definition = extract.pggls)
```
```{r}
screenreg(list(mundlak2, fixed_oneway), digits=3, single.row=TRUE)
screenreg(list(mundlak1, fixed_pggls), digits=3, single.row=TRUE)
```


```{r}
waldtest(mundlak1, c(9:16))
waldtest(mundlak2, c(9:16))
```
(viii) What are your overall conclusions from the analysis of heterogeneity in returns to schooling
by ethnicity?\\

1. Hausmant test and wald test indicate correlation between fixed effects and regressors. So we should use the fixed effects model. Our estimations have shown that the interaction effect between schooling and being black is significant and negative. So there evidence for discrimination on the labour market. etc.

(ix) To gain insights on the impact of nonresponse and attrition, the researcher applies a variant
of the Verbeek and Nijman-test. He defines the dummy variable $d_i$ which is 1 if the individual
is in the panel for more than 5 waves, and is zero otherwise. Apply the Verbeek and Nijman
test with this definition of $d_i$ (otherwise equal to the definition in the lecture slides). Draw
conclusions and address practical problems you possibly met in implementing the test.\\

```{r}
data <- data %>% group_by(id) %>%
  mutate(dummy = ifelse(length(id) > 5, 1, 0))
```

```{r}
fixedbalanced  <- plm(lnearnings ~ school + age + agesq + ethblack + ethblack  * school + urban + regne + regnc + regw + asvabc, model = "within", index = c("id", "time"), effect = "twoways", data = subset(data, dummy==1))

fixedbalanced$vcov <- vcovHC(fixedbalanced, cluster="group")

phtest(fixed, fixedbalanced)
```

We already had practical problems all along. The question is how to include robust standard errors in the Hausmantest.
P value is very high so we can reject $H_0$. Hence, there is no evidence for attrition bias. As the estimation with the unbalanced data is more efficient, we should use that one.

\clearpage

# References

